<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Registro de Incidencias</title>
        <link rel="stylesheet" href="/static/style.css">
    </head>
    <body>
        <div class="bg-logo" aria-hidden="true"></div>
        <header class="topbar">
            <h1><a href="/" style="display:inline-flex;align-items:center;text-decoration:none;color:inherit;"><img src="/static/mitie_logo.png" srcset="/static/mitie_logo@2x.png 2x" class="brand-logo" alt="Mitie" width="56" decoding="async"></a>Registro de Incidencias</h1>
            <div style="display:flex;align-items:center;gap:12px">
                {% if current_user.is_authenticated %}
                    <a class="user-badge" href="/perfil">Operador: {{ current_user.username }}</a>
                {% endif %}
                <div>
                <a class="history-link" href="/">Volver</a>
                {% if current_user.is_authenticated and current_user.tiene_permiso('administracion') %}
                  &nbsp;|&nbsp;
                  <a class="history-link" href="/administracion">Administración</a>
                {% endif %}
            </div>
        </header>
        <main class="container history">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <script>window.server_messages = {{ messages | tojson }};</script>
              {% endif %}
            {% endwith %}

            <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

            <div class="search-box">
                <h3>Búsqueda</h3>
                <form method="get" action="/incidents" style="display:inline-block;">
                    <label>IMEI: <input type="text" name="imei" value="{{ imei_search }}" placeholder="Buscar por IMEI"></label>
                    <label>Usuario: <input type="text" name="usuario" value="{{ usuario_search }}" placeholder="Buscar por usuario"></label>
                    <label>Desde: <input type="date" name="fecha_inicio" value="{{ fecha_inicio }}"></label>
                    <label>Hasta: <input type="date" name="fecha_fin" value="{{ fecha_fin }}"></label>
                    <button type="submit" class="btn-secondary btn-small">Buscar</button>
                </form>
                <div class="dropdown-menu">
                  <button class="dropdown-toggle" onclick="toggleDropdown(event)">Herramientas ▼</button>
                  <div class="dropdown-content">
                    <button class="dropdown-item" type="button" onclick="document.querySelector('form[action=\"/incidents\"]').submit(); toggleDropdown(event);">Buscar</button>
                    <a href="/incidents" class="dropdown-item">Limpiar</a>
                    <button id="select-all-rows" class="dropdown-item" type="button">Seleccionar todo</button>
                    <button id="deselect-all-rows" class="dropdown-item" type="button">Deseleccionar</button>
                    <button id="export-all-btn" class="dropdown-item" type="button" onclick="const imei = new URLSearchParams(window.location.search).get('imei'); const usuario = new URLSearchParams(window.location.search).get('usuario'); const params = new URLSearchParams(); if(imei) params.set('imei', imei); if(usuario) params.set('usuario', usuario); window.location.href = '/incidents/export?' + params.toString();">Exportar todo</button>
                    <button id="export-selected-btn" class="dropdown-item" type="button">Exp selec</button>
                  </div>
                </div>
            </div>
            <div style="margin-top:12px">
                <button id="delete-selected-btn" type="button" class="btn-secondary btn-danger">Borrar seleccionados</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>IMEI</th>
                        <th>Usuario</th>
                        <th>Teléfono</th>
                        <th>Notas</th>
                        <th>Archivo</th>
                        <th>Fecha (UTC)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incident in incidents %}
                    <tr>
                        <td><input type="checkbox" class="row-select" value="{{ incident['id'] }}"></td>
                        <td>{{ incident['imei'] }}</td>
                        <td>{{ incident['usuario'] }}</td>
                        <td>{{ incident['telefono'] }}</td>
                        <td>{{ incident['notas'] }}</td>
                        <td><a href="/incidents/download/{{ incident['id'] }}" style="color:#d32f2f;text-decoration:none">{{ incident['archivo_nombre'] }}</a></td>
                        <td>{{ incident['timestamp'] }}</td>
                        {% if current_user.is_authenticated and current_user.tiene_permiso('administracion') %}
                        <td><a href="/incidencia/{{ incident['id'] }}/editar" class="btn-secondary btn-small">Editar</a></td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr><td colspan="7">No hay incidencias registradas.</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if total_pages > 1 %}
            <nav class="pagination" style="margin-top:16px;display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap;">
              {% if page > 1 %}
                <a href="?page={{ page - 1 }}&imei={{ imei_search }}&usuario={{ usuario_search }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}" class="btn-secondary btn-small">&laquo; Anterior</a>
              {% endif %}
              {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                  <span style="font-weight:bold;padding:4px 10px;background:#e30613;color:#fff;border-radius:4px;">{{ p }}</span>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                  <a href="?page={{ p }}&imei={{ imei_search }}&usuario={{ usuario_search }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}" class="btn-secondary btn-small">{{ p }}</a>
                {% elif p == 4 or p == total_pages - 3 %}
                  <span>…</span>
                {% endif %}
              {% endfor %}
              {% if page < total_pages %}
                <a href="?page={{ page + 1 }}&imei={{ imei_search }}&usuario={{ usuario_search }}&fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}" class="btn-secondary btn-small">Siguiente &raquo;</a>
              {% endif %}
              <span style="margin-left:12px;font-size:0.9em;color:#666;">Página {{ page }} de {{ total_pages }} ({{ total }} registros)</span>
            </nav>
            {% endif %}
        </main>
        <script src="/static/app.js"></script>
    </body>
</html>
