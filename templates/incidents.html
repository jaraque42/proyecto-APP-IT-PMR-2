<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Registro de Incidencias</title>
        <link rel="stylesheet" href="/static/style.css">
    </head>
    <body>
        <div class="bg-logo" aria-hidden="true"></div>
        <header class="topbar">
               <h1><img src="/static/mitie_logo.png" srcset="/static/mitie_logo@2x.png 2x" class="brand-logo" alt="Mitie" width="56" decoding="async">Registro de Incidencias</h1>
            <div>
                <a class="history-link" href="/">Volver</a>
                {% if current_user.is_authenticated and current_user.tiene_permiso('administracion') %}
                  &nbsp;|&nbsp;
                  <a class="history-link" href="/administracion">Administración</a>
                {% endif %}
                &nbsp;|&nbsp;
                                {% if current_user.is_authenticated %}
                                    <a class="history-link" href="/perfil/cambiar_contrasena">Cambiar clave</a>
                                    &nbsp;|&nbsp;
                                {% endif %}
                <a class="history-link" href="/logout">Cerrar Sesión</a>
            </div>
        </header>
        <main class="container history">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <script>window.server_messages = {{ messages | tojson }};</script>
              {% endif %}
            {% endwith %}

            <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

            <div class="search-box">
                <h3>Búsqueda</h3>
                <form method="get" action="/incidents" style="display:inline-block;">
                    <label>IMEI: <input type="text" name="imei" value="{{ imei_search }}" pattern="\d{15}" inputmode="numeric" minlength="15" maxlength="15" placeholder="15 dígitos" title="IMEI de 15 dígitos"></label>
                    <label>Usuario: <input type="text" name="usuario" value="{{ usuario_search }}" placeholder="Apellido1, Apellido2, Nombre" title="Formato: Apellido1, Apellido2, Nombre"></label>
                    <button type="submit" style="padding:8px 16px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:14px;color:#000;font-weight:bold">Buscar</button>
                    <a href="/incidents" style="margin-left:10px;padding:8px 16px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;text-decoration:none;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:14px;color:#000;font-weight:bold">Limpiar</a>
                </form>
                <button id="select-all-rows" type="button" style="margin-left:10px;padding:8px 16px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:14px;color:#000;font-weight:bold">Seleccionar todo</button>
                <button id="deselect-all-rows" type="button" style="margin-left:6px;padding:8px 16px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:14px;color:#000;font-weight:bold">Deseleccionar</button>
                <button id="export-all-btn" type="button" style="margin-left:6px;padding:8px 16px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:14px;color:#000;font-weight:bold" onclick="const imei = new URLSearchParams(window.location.search).get('imei'); const usuario = new URLSearchParams(window.location.search).get('usuario'); const params = new URLSearchParams(); if(imei) params.set('imei', imei); if(usuario) params.set('usuario', usuario); window.location.href = '/incidents/export?' + params.toString();">Exportar todo</button>
                <button id="export-selected-btn" type="button" style="margin-left:6px;padding:8px 16px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:14px;color:#000;font-weight:bold">Exportar seleccionados</button>
            </div>
            <div style="margin-top:12px">
                <button id="delete-selected-btn" type="button" style="padding:6px 12px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.1);font-size:12px;color:#d32f2f;font-weight:bold">Borrar seleccionados</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>IMEI</th>
                        <th>Usuario</th>
                        <th>Teléfono</th>
                        <th>Notas</th>
                        <th>Archivo</th>
                        <th>Fecha (UTC)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incident in incidents %}
                    <tr>
                        <td><input type="checkbox" class="row-select" value="{{ incident['id'] }}"></td>
                        <td>{{ incident['imei'] }}</td>
                        <td>{{ incident['usuario'] }}</td>
                        <td>{{ incident['telefono'] }}</td>
                        <td>{{ incident['notas'] }}</td>
                        <td><a href="/incidents/download/{{ incident['id'] }}" style="color:#d32f2f;text-decoration:none">{{ incident['archivo_nombre'] }}</a></td>
                        <td>{{ incident['timestamp'] }}</td>
                        {% if current_user.is_authenticated and current_user.tiene_permiso('administracion') %}
                        <td><a href="/incidencia/{{ incident['id'] }}/editar" class="btn small">Editar</a></td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr><td colspan="7">No hay incidencias registradas.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </main>
        <script src="/static/app.js"></script>
    </body>
</html>
